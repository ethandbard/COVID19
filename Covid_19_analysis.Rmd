---
title: "COVID-19 Variants Analysis"
output: html_notebook
---

```{r, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)
```

```{r, echo = FALSE, message=FALSE, warning=FALSE, comment=FALSE}
library(tidyverse)
library(scales)
library(plotly)
library(DT)
library(data.table)
library(gtable)
library(plotly)
library(lubridate)
library(vtable)
library(rjson)
library(timetk)
library(Rssa)
library(RColorBrewer)
library(gghighlight)

`%!in%` <- Negate(`%in%`)
```

```{r, echo = FALSE, warning=FALSE}
covid <- read_csv("data/owid-covid-data.csv",show_col_types = FALSE)
#variants <- read_csv("data/covid-variants.csv",show_col_types = FALSE)

gisaid <- as.data.frame(fread("data/gisaid_variants_statistics.tsv")) %>% 
  rename(date = `Week prior to`,
         count = `Submission Count`,
         perc_sequences = `% per Country and Week`,
         total = `Total per Country and Week`,
         variant = Value) %>% 
  mutate(date = ymd(date),
         perc_sequences = round(count / total * 100, 3))# %>% 
#  separate(variant, into = c("variant", "origin"), sep = c("first detected in "))

gisaid_variants <- gisaid %>% 
  filter(Type == "Variant") %>%
  separate(variant, c("variant", "origin"), sep = "first detected in ") %>% 
  select(-Type)
```

```{r}
covid_NAs <- covid %>% 
  group_by(location) %>% 
  summarise_all(funs(sum(is.na(.)))) %>% 
  pivot_longer(cols = -location, names_to = "Variable", values_to = "NAs") %>% 
  mutate(Percent = round(NAs / nrow(covid) * 100 ,2)) %>% 
  arrange(-NAs)
```

```{r}
covid_NAs %>% 
  group_by(location) %>% 
  summarise(total_pct_na = sum(Percent)) %>% 
  arrange(total_pct_na) %>% 
  datatable(filter = 'top')
```

```{r}
#Helper function for filtering data
my_data <- function(country_covid_filter, country_gisaid_filter){
  data <- covid %>% 
    filter(location == country_covid_filter)
  gisaid_data <- gisaid_variants %>% 
    filter(Country == country_gisaid_filter)
  data <- left_join(data, gisaid_data, by = "date")
  data
}

#covid - United States
#gisaid - "USA"

us <- my_data("United States", "USA")
```


```{r "US Plots"}
variants_plot <- ggplot(data = us, aes(x = date)) +
  geom_area(aes(y = perc_sequences, color = variant, fill = variant), position = "dodge", show.legend = FALSE) +
  theme_minimal()


cases_plot <-
  ggplot(data = us, aes(x = date)) +
  geom_line(aes(y = new_cases_per_million), show.legend = FALSE) +
  geom_line(aes(y = new_deaths_per_million)) + 
  theme_minimal()


deaths_plot <- ggplot(data = us, aes(x = date)) +
  geom_line(aes(y = new_deaths_per_million)) + 
  theme_minimal()


vaccinations_plot <- ggplot(us, aes(x = date)) +
  geom_line(aes(y = new_vaccinations_smoothed_per_million)) +
  theme_minimal()


variants_cases_plot <- ggplot(data = us, aes(x = date)) + 
  geom_area(aes(y = perc_sequences, color = variant, fill = variant), show.legend =FALSE, alpha = 0.5, position = "dodge") + 
  geom_line(aes(y = new_cases_smoothed_per_million / 40)) + 
  scale_y_continuous("Percent of Sequences", sec.axis=sec_axis(~.*40, name = "New Cases Per Million")) + 
  theme_minimal() + 
  labs(title = "Proportion of Covid Variants vs New Cases Per Million")  +
  annotate(geom="label", x=ymd(20200701), y=75, label="Alpha/Other") +
  annotate(geom="label", x=ymd(20210901), y=75, label="Delta") +
  annotate(geom="label", x=ymd(20220201), y=75, label="Omicron")


variants_deaths_plot <- ggplot(data = us, aes(x = date)) + 
  geom_area(aes(y = perc_sequences, color = variant, fill = variant),show.legend =FALSE, alpha = 0.5, position = "dodge") + 
  geom_line(aes(y = new_deaths_smoothed_per_million*5)) + 
  scale_y_continuous("Percent of Sequences", sec.axis=sec_axis(~./5, name = "New Deaths Per Million")) + 
  theme_minimal() + 
  labs(title = "Proportion of Covid Variants vs New Deaths Per Million") +
  annotate(geom="label", x=ymd(20200701), y=75, label="Alpha/Other") +
  annotate(geom="label", x=ymd(20210901), y=75, label="Delta") +
  annotate(geom="label", x=ymd(20220201), y=75, label="Omicron")


cases_vaccinations_plot <- ggplot(data = us, aes(x = date)) +
  geom_line(aes(y = new_cases_smoothed_per_million), show.legend = FALSE) +
  geom_line(aes(y = people_vaccinated_per_hundred*50)) + 
  scale_y_continuous("New Cases Per Million", sec.axis=sec_axis(~./50, name = "People Vaccinated Per Hundred")) + 
  theme_minimal() + 
  labs(title = "New Cases Per Million vs. People Vaccinated Per Hundred")

deaths_vaccinations_plot <- ggplot(us, aes(x = date)) +
  geom_line(aes(y = new_deaths_per_million), show.legend = FALSE) +
  geom_line(aes(y = people_fully_vaccinated_per_hundred/7)) + 
  scale_y_continuous("New Deaths Per Million", sec.axis=sec_axis(~.*7, name = "People Vaccinated Per Hundred")) + 
  theme_minimal() + 
  labs(title = "New Deaths Per Million vs. People Fully Vaccinated Per Hundred")


variants_hospitalizations_plot <- ggplot(us, aes(x = date)) + 
  geom_area(aes(y = perc_sequences, color = variant, fill = variant), show.legend =FALSE, alpha = 0.5, position = "dodge") + 
  geom_line(aes(y = weekly_hosp_admissions_per_million / 5)) + 
  scale_y_continuous("Percent of Sequences", sec.axis=sec_axis(~.*5, name = "Hospitalizations Per Million")) + 
  theme_minimal() + 
  labs(title = "Proportion of Covid Variants vs Hospitalizations Per Million") +
  annotate(geom="label", x=ymd(20200701), y=75, label="Alpha/Other") +
  annotate(geom="label", x=ymd(20210901), y=75, label="Delta") +
  annotate(geom="label", x=ymd(20220201), y=75, label="Omicron")

variants_vaccinations_plot <- ggplot(us, aes(x = date)) + 
  geom_area(aes(y = perc_sequences, color = variant, fill = variant), show.legend =FALSE, alpha = 0.5, position = "dodge") + 
  geom_line(aes(y = people_fully_vaccinated_per_hundred)) + 
  scale_y_continuous("Percent of Sequences", sec.axis=sec_axis(~., name = "People Vaccinated Per Hundred")) + 
  theme_minimal() + 
  labs(title = "Proportion of Covid Variants vs People Fully Vaccinated") +
  annotate(geom="label", x=ymd(20200701), y=75, label="Alpha/Other") +
  annotate(geom="label", x=ymd(20210901), y=75, label="Delta") +
  annotate(geom="label", x=ymd(20220201), y=75, label="Omicron")

variants_vaccinations_plot
```

```{r}
vaccinations_plot
```


```{r}
variants_cases_plot <- ggplot(data = us, aes(x = date)) + 
  geom_area(aes(y = perc_sequences, color = variant, fill = variant), show.legend =FALSE, alpha = 0.5, position = "dodge") + 
  geom_line(aes(y = new_cases_smoothed_per_million / 40)) + 
  scale_y_continuous("Percent of Sequences", sec.axis=sec_axis(~.*40, name = "New Cases Per Million")) + 
  theme_minimal() + 
  labs(title = "Proportion of Covid Variants vs New Cases Per Million") +
  annotate(geom="label", x=ymd(20200701), y=75, label="Alpha/Other") +
  annotate(geom="label", x=ymd(20210901), y=75, label="Delta") +
  annotate(geom="label", x=ymd(20220201), y=75, label="Omicron")

variants_cases_plot
```

```{r}
variants_hospitalizations_plot
```

```{r}
variants_deaths_plot
```


# Time Series Analysis

```{r}
us %>% 
  plot_time_series(date, new_cases_smoothed_per_million)
```

```{r}
us %>% 
  plot_acf_diagnostics(date, new_cases_smoothed_per_million, .show_white_noise_bars = T) 
```


```{r}
gisaid_variants %>% 
  filter(Country == "USA", variant %in% c("VOC Omicron GRA (B.1.1.529+BA.*) ", "VOC Delta GK (B.1.617.2+AY.*) ", "VOC Alpha GRY (B.1.1.7+Q.*) ")) %>% 
  plot_time_series(date, perc_sequences, .facet_vars=variant, .legend_show = FALSE)
```

```{r}
gisaid_variants %>% 
  filter(Country == "USA", variant %in% c("VOC Omicron GRA (B.1.1.529+BA.*) ", "VOC Delta GK (B.1.617.2+AY.*) ", "VOC Alpha GRY (B.1.1.7+Q.*) ")) %>% 
  group_by(variant) %>% 
  plot_acf_diagnostics(date, perc_sequences, .show_white_noise_bars = T) 
```

```{r}
library("sf")
library("rnaturalearth")
library("rnaturalearthdata")

world <- ne_countries(scale = "medium", returnclass = "sf")
class(world)
```

```{r}
world_variants_df <- gisaid_variants %>% 
    group_by(Country,) %>% 
    mutate(Country = case_when(
      Country == "USA" ~ "United States",
          TRUE ~ as.character(Country)
          )) %>% 
  summarise(most_recent_date = date[n()],
            prevalent_variant = variant[date == date[n()] & perc_sequences == max(perc_sequences[date == date[n()]])],
            .groups = 'drop') %>% 
  arrange(desc(most_recent_date)) %>% 
  rename(location = Country)

world_variants_df %>% 
  arrange(most_recent_date)
```

```{r, warning=FALSE}
world_cases_per_mil_df <- covid %>% 
  group_by(location) %>% 
  summarise(most_recent_date = date[max(which(!is.na(new_cases_smoothed_per_million)))],
              new_cases_per_mil = new_cases_smoothed_per_million[max(which(!is.na(new_cases_smoothed_per_million)))])

world_cases_df <- covid %>% 
  group_by(location) %>% 
  summarise(most_recent_date = date[max(which(!is.na(new_cases_smoothed)))],
              new_cases = new_cases_smoothed[max(which(!is.na(new_cases_smoothed)))])
```

```{r}
world_variants_loc <- left_join(world_variants_df, covid[, c("location", "iso_code")], by = "location", all.x = TRUE, all.y = FALSE) %>% 
  rename(gu_a3 = iso_code) %>% 
  unique()

world_cases_per_mil_loc <- left_join(world_cases_per_mil_df, covid[, c("location", "iso_code")], by = "location", all.x = TRUE, all.y = FALSE) %>% 
  rename(gu_a3 = iso_code) %>% 
  unique()

world_cases_loc <- left_join(world_cases_df, covid[, c("location", "iso_code")], by = "location", all.x = TRUE, all.y = FALSE) %>% 
  rename(gu_a3 = iso_code) %>% 
  unique()

world_variants_map <- left_join(world, world_variants_loc, by = "gu_a3", all.x = TRUE)

world_cases_per_mil_map <- left_join(world, world_cases_per_mil_loc, by = "gu_a3", all.x = TRUE)

world_cases_map <- left_join(world, world_cases_loc, by = "gu_a3", all.x = TRUE)
```

```{r}
p <- ggplot(data = world_variants_map, aes(fill = prevalent_variant, text = paste0("Country: ", name, "\nLast date: ", most_recent_date))) + 
  geom_sf() + 
  xlab("") + 
  ylab("") + 
  labs(title = "Most Prevalent Covid Variant by Country") +
  theme(panel.grid.major = element_line(color = gray(.5), linetype = "dashed", size = 0.5), panel.background = element_rect(fill = "white"),                legend.position = "bottom", 
              legend.text= element_text(size = 5),
              legend.title = element_blank(),
              legend.key.size = unit(1, "line")
              ) 

p
```

```{r}
p <- ggplot(data = world_cases_per_mil_map, aes(fill = new_cases_per_mil, text = paste0("Country: ", name, "\nLast date: ", most_recent_date))) + 
  geom_sf() + 
  xlab("") + 
  ylab("") +
  labs(fill = "New Cases Per Million") + 
  labs(title = "New Cases Per Million by Country") +
  theme(panel.grid.major = element_line(color = gray(.5), linetype = "dashed", size = 0.5), panel.background = element_rect(fill = "white"),                legend.position = "bottom", 
              legend.text= element_text(size = 5),
              legend.key.size = unit(1, "line")
              ) + 
  scale_fill_viridis_c(option = "F", direction = -1)

p
```

```{r}
p <- ggplot(data = world_cases_map, aes(fill = new_cases, text = paste0("Country: ", name, "\nLast date: ", most_recent_date))) + 
  geom_sf() + 
  xlab("") + 
  ylab("") +
  labs(fill = "New Cases") + 
  labs(title = "New Cases by Country") +
  theme(panel.grid.major = element_line(color = gray(.5), linetype = "dashed", size = 0.5), panel.background = element_rect(fill = "white"),                legend.position = "bottom", 
              legend.text= element_text(size = 5),
              legend.key.size = unit(1, "line")
              ) + 
  scale_fill_viridis_c(option = "F", direction = -1)

p
```


```{r}
world_cases_per_mil_df %>% 
  arrange(-new_cases_per_mil)
```

```{r}
world_cases_df %>% 
  filter(location %!in% c("World", "High income", "Europe", "European Union", "Asia", "Upper middle income", "Lower middle income", "Oceania", "North America", "South America")) %>% 
  arrange(-new_cases)
```

```{r}
cases <- covid %>% 
  filter(location %!in% c("World", "High income", "Europe", "European Union", "Asia", "Upper middle income", "Lower middle income", "Oceania", "North America", "South America")) %>% 
  select(date, location, new_cases_smoothed) %>%
  drop_na() %>% 
  glimpse()
```

```{r}
spread_cases <- cases %>% 
  spread(location, new_cases_smoothed)
```

```{r}
cases <- t(spread_cases[-1])
cases_dist <- dist(cases, method = "euclidean")
fit <- hclust(cases_dist, method = "ward.D")
```

```{r}
library(ggdendro)
ggdendrogram(fit, rotate = TRUE, theme_dendro = FALSE) + 
  theme_minimal() + 
  xlab("") +
  ylab("") 
```

```{r}
d <- cut(as.dendrogram(fit), h = 10000000)
d
```

```{r}
plot(d$lower[[2]])
par(mfrow = c(1,1))
```

```{r}
clustered_data <- cutree(fit, k = 4)
clustered_data_tidy <- as.data.frame(as.table(clustered_data)) %>% 
  glimpse()
colnames(clustered_data_tidy) <- c("location", "cluster")
clustered_data_tidy$location <- as.character(clustered_data_tidy$location)

joined_clusters <- cases %>% 
  inner_join(clustered_data_tidy, by = "location") %>% 
  glimpse()
```

```{r}
table(clustered_data_tidy$cluster)
```

```{r}
cluster3 <- joined_clusters %>% 
  filter(cluster == "3")

ggplot(cluster3, aes(date, new_cases_smoothed)) +
  geom_line(color = "grey") +
  theme_minimal() +
  geom_smooth(method = "auto", color = "red", se = F, size = 0.5) +
  facet_wrap(~location)
```

