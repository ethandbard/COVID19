---
title: "COVID-19 Dataset Analysis"
output: html_notebook
---

```{r, echo = FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(scales)
library(plotly)
library(DT)
library(data.table)
library(gtable)
library(plotly)
library(lubridate)
library(vtable)
library(rjson)
```

```{r, echo = FALSE}
covid <- read_csv("data/owid-covid-data.csv",show_col_types = FALSE)
variants <- read_csv("data/covid-variants.csv",show_col_types = FALSE)
```

```{r}
USAClusters <- fromJSON(file = "data/USAClusters_data.json")
USAClusters <- USAClusters$countries$USA
USAClusters <- as.data.frame(USAClusters) %>% 
  mutate(week = ymd(week)) %>% 
  arrange(week) %>% 
  pivot_longer(cols = -c(week, total_sequences), names_to = "variant", values_to = "sequences") %>% 
  mutate(perc_sequences = round(sequences / total_sequences * 100, 2)) %>% 
  rename(date = week)

USAClusters
```


```{r}
sumtable(covid)
```


```{r}
covid_NAs <- covid %>% 
  group_by(location) %>% 
  summarise_all(funs(sum(is.na(.)))) %>% 
  pivot_longer(cols = -location, names_to = "Variable", values_to = "NAs") %>% 
  mutate(Percent = round(NAs / nrow(covid) * 100 ,2)) %>% 
  arrange(-NAs)

covid_NAs
```

```{r}
DT::datatable(
  covid_NAs, filter = 'top',
  #options = list(
 #   columnDefs = list(list(targets = 1, searchable = FALSE))
  #)
)
```

```{r}
covid_NAs %>% 
  group_by(location) %>% 
  summarise(total_pct_na = sum(Percent)) %>% 
  arrange(total_pct_na) %>% 
  datatable(filter = 'top')
```

```{r}
covid %>% 
  colnames()
```

```{r}
head(covid$date)
```
 
```{r}
us <- covid %>% 
  filter(location == "United States") 

us <- left_join(us, USAClusters, by = "date")
```

```{r}
variants_plot <- us %>% 
  ggplot(aes(x = date)) +
  geom_line(aes(y = perc_sequences, color = variant), show.legend = FALSE) +
 # geom_vline(aes(xintercept = ymd(20200706)), color = "black") +
 # geom_vline(aes(xintercept = ymd(20210517)), color = "black") + 
 # geom_vline(aes(xintercept = ymd(20211004)), color = "black") + 
  #  geom_vline(aes(xintercept = ymd(20220105)), color = "black") + 
  theme_minimal()

cases_plot <- us %>% 
  ggplot(aes(x = date)) +
  geom_line(aes(y = new_cases_per_million), show.legend = FALSE) +
  geom_line(aes(y = new_deaths_per_million)) + 
 # geom_vline(aes(xintercept = ymd(20200706)), color = "black") +
 # geom_vline(aes(xintercept = ymd(20210517)), color = "black") + 
 # geom_vline(aes(xintercept = ymd(20211004)), color = "black") + 
  #  geom_vline(aes(xintercept = ymd(20220105)), color = "black") + 
  theme_minimal()

deaths_plot <- us %>% 
  ggplot(aes(x = date)) +
  geom_line(aes(y = new_deaths_per_million)) + 
 # geom_vline(aes(xintercept = ymd(20200706)), color = "black") +
#geom_vline(aes(xintercept = ymd(20210517)), color = "black") + 
#  geom_vline(aes(xintercept = ymd(20211004)), color = "black") + 
  #  geom_vline(aes(xintercept = ymd(20220105)), color = "black") + 
  theme_minimal()
```

```{r}
ggplotly(variants_plot)
```

```{r}
cases_plot
```

```{r}
deaths_plot
```

```{r}
us %>% 
  ggplot(aes(x = date)) +
  geom_line(aes(y = people_vaccinated_per_hundred)) +
#  geom_vline(aes(xintercept = ymd(20200706)), color = "black") +
# geom_vline(aes(xintercept = ymd(20210517)), color = "black") + 
# geom_vline(aes(xintercept = ymd(20211004)), color = "black") + 
#    geom_vline(aes(xintercept = ymd(20220105)), color = "black") + 
  theme_minimal()
```

```{r}
covid$date[length(covid$date)]
USAClusters$date[length(USAClusters$date)]
```

```{r}

```

```{r}
max(us$new_cases_per_million, na.rm = TRUE)
```


```{r, warn = FALSE}
ggplot(us, aes(x = date)) + 
  geom_area(aes(y = perc_sequences, color = variant, fill = variant), alpha = 0.5, position = "dodge") + 
  geom_line(aes(y = new_cases_per_million / 40)) + 
  scale_y_continuous("Percent of Sequences", sec.axis=sec_axis(~.*40, name = "New Cases Per Million")) + 
  theme_minimal() + 
  labs(title = "Proportion of Covid Variants vs New Cases Per Million") -> p

ggplotly(p)
```

